<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration vers Firebase - Gestion Arr√™t Annuel</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #1a1a2e;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .step {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .step h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-number {
            background: #4f46e5;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .step p {
            color: #666;
            margin-bottom: 15px;
        }
        input[type="file"] {
            display: none;
        }
        .file-label {
            display: inline-block;
            background: #4f46e5;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-label:hover {
            background: #4338ca;
            transform: translateY(-2px);
        }
        .file-name {
            margin-top: 10px;
            color: #10b981;
            font-weight: 500;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .log-entry.success { color: #10b981; }
        .log-entry.error { color: #ef4444; }
        .log-entry.info { color: #60a5fa; }
        .log-entry.warning { color: #f59e0b; }
        .progress {
            background: #e5e7eb;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, #4f46e5, #10b981);
            height: 100%;
            width: 0%;
            transition: width 0.5s;
            border-radius: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat {
            background: #f0fdf4;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #10b981;
        }
        .stat-label {
            color: #666;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Migration vers Firebase</h1>
        <p class="subtitle">Transf√©rez vos donn√©es locales vers Firestore</p>

        <div class="step">
            <h3><span class="step-number">1</span> S√©lectionner le fichier de donn√©es</h3>
            <p>Choisissez le fichier <code>application-data.json</code> depuis le dossier <code>server/data/</code></p>
            <label class="file-label" for="dataFile">
                üìÅ Choisir le fichier JSON
            </label>
            <input type="file" id="dataFile" accept=".json">
            <div class="file-name" id="fileName"></div>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span> Migrer vers Firebase</h3>
            <p>Cliquez sur le bouton ci-dessous pour transf√©rer toutes les donn√©es vers Firestore</p>
            <button id="migrateBtn" disabled>üöÄ Lancer la migration</button>
        </div>

        <div class="progress" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat">
                <div class="stat-value" id="statModules">0</div>
                <div class="stat-label">Modules</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="statItems">0</div>
                <div class="stat-label">√âl√©ments</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="statSize">0 KB</div>
                <div class="stat-label">Taille</div>
            </div>
        </div>

        <div class="log" id="log" style="display: none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAbw3ygWzqCWd01eLfIP_qL0lUNb8oxE9U",
            authDomain: "gestion-arret-annuel.firebaseapp.com",
            projectId: "gestion-arret-annuel",
            storageBucket: "gestion-arret-annuel.firebasestorage.app",
            messagingSenderId: "667890337672",
            appId: "1:667890337672:web:eb8385f9496c00ca911c3d"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // √âl√©ments DOM
        const fileInput = document.getElementById('dataFile');
        const fileName = document.getElementById('fileName');
        const migrateBtn = document.getElementById('migrateBtn');
        const progressBar = document.getElementById('progressBar');
        const logContainer = document.getElementById('log');
        const statsContainer = document.getElementById('stats');

        let dataToMigrate = null;

        // Fonction de log
        function log(message, type = 'info') {
            logContainer.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Gestionnaire de fichier
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            fileName.textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;

            try {
                const text = await file.text();
                dataToMigrate = JSON.parse(text);

                // Afficher les stats
                const moduleCount = Object.keys(dataToMigrate).filter(k =>
                    k !== 'lastUpdated' && k !== 'lastUpdatedBy'
                ).length;

                let itemCount = 0;
                for (const [key, value] of Object.entries(dataToMigrate)) {
                    if (Array.isArray(value)) {
                        itemCount += value.length;
                    } else if (value && typeof value === 'object') {
                        itemCount += Object.keys(value).length;
                    }
                }

                document.getElementById('statModules').textContent = moduleCount;
                document.getElementById('statItems').textContent = itemCount;
                document.getElementById('statSize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
                statsContainer.style.display = 'grid';

                migrateBtn.disabled = false;
                log(`Fichier charg√© avec succ√®s: ${moduleCount} modules, ${itemCount} √©l√©ments`, 'success');

            } catch (error) {
                log(`Erreur lors de la lecture du fichier: ${error.message}`, 'error');
                migrateBtn.disabled = true;
            }
        });

        // Gestionnaire de migration
        migrateBtn.addEventListener('click', async () => {
            if (!dataToMigrate) return;

            migrateBtn.disabled = true;
            migrateBtn.textContent = '‚è≥ Migration en cours...';
            document.querySelector('.progress').style.display = 'block';

            try {
                log('D√©marrage de la migration vers Firebase...', 'info');

                // Ajouter un timestamp
                dataToMigrate.lastUpdated = new Date().toISOString();
                dataToMigrate.lastUpdatedBy = 'migration-tool';

                // Calculer la taille des donn√©es
                const dataSize = JSON.stringify(dataToMigrate).length;
                log(`Taille totale des donn√©es: ${(dataSize / 1024).toFixed(1)} KB`, 'info');

                // V√©rifier si les donn√©es sont trop volumineuses (limite Firestore: ~1MB par document)
                if (dataSize > 900000) {
                    log('‚ö†Ô∏è Donn√©es volumineuses - Migration par modules...', 'warning');
                    await migrateByModules(dataToMigrate);
                } else {
                    // Migration simple - un seul document
                    progressBar.style.width = '50%';
                    log('Envoi des donn√©es vers Firestore...', 'info');

                    const docRef = doc(db, 'applicationData', 'mainData');
                    await setDoc(docRef, dataToMigrate);

                    progressBar.style.width = '100%';
                    log('‚úÖ Migration termin√©e avec succ√®s!', 'success');
                }

                migrateBtn.textContent = '‚úÖ Migration termin√©e!';
                migrateBtn.style.background = '#10b981';

                log('', 'info');
                log('üéâ Vos donn√©es sont maintenant sur Firebase!', 'success');
                log('Vous pouvez maintenant utiliser l\'application en mode Firebase.', 'info');

            } catch (error) {
                log(`‚ùå Erreur de migration: ${error.message}`, 'error');
                console.error(error);
                migrateBtn.textContent = '‚ùå Erreur - R√©essayer';
                migrateBtn.disabled = false;
                migrateBtn.style.background = '#ef4444';
            }
        });

        // Fonction pour convertir les tableaux imbriqu√©s en objets (Firestore ne supporte pas les nested arrays)
        function sanitizeForFirestore(data) {
            if (Array.isArray(data)) {
                return data.map((item, index) => {
                    if (Array.isArray(item)) {
                        // Convertir le tableau imbriqu√© en objet avec index
                        const obj = { _isArray: true, _length: item.length };
                        item.forEach((subItem, subIndex) => {
                            obj[`_${subIndex}`] = sanitizeForFirestore(subItem);
                        });
                        return obj;
                    }
                    return sanitizeForFirestore(item);
                });
            } else if (data !== null && typeof data === 'object') {
                const result = {};
                for (const [key, value] of Object.entries(data)) {
                    result[key] = sanitizeForFirestore(value);
                }
                return result;
            }
            return data;
        }

        // Fonction r√©cursive pour d√©couper n'importe quelle structure
        function splitLargeData(data, maxSize = 700000) {
            const dataStr = JSON.stringify(data);
            if (dataStr.length <= maxSize) {
                return [data];
            }

            // Si c'est un tableau
            if (Array.isArray(data)) {
                const chunks = [];
                let currentChunk = [];
                let currentSize = 0;

                for (const item of data) {
                    const itemStr = JSON.stringify(item);
                    if (itemStr.length > maxSize) {
                        // Item trop gros, le d√©couper r√©cursivement
                        if (currentChunk.length > 0) {
                            chunks.push(currentChunk);
                            currentChunk = [];
                            currentSize = 0;
                        }
                        const subChunks = splitLargeData(item, maxSize);
                        subChunks.forEach((sc, i) => chunks.push({ _subItem: true, index: i, total: subChunks.length, data: sc }));
                    } else if (currentSize + itemStr.length > maxSize && currentChunk.length > 0) {
                        chunks.push(currentChunk);
                        currentChunk = [item];
                        currentSize = itemStr.length;
                    } else {
                        currentChunk.push(item);
                        currentSize += itemStr.length;
                    }
                }
                if (currentChunk.length > 0) chunks.push(currentChunk);
                return chunks;
            }

            // Si c'est un objet
            if (typeof data === 'object' && data !== null) {
                const chunks = [];
                let currentChunk = {};
                let currentSize = 0;

                for (const [key, value] of Object.entries(data)) {
                    const valueStr = JSON.stringify(value);
                    if (valueStr.length > maxSize) {
                        // Valeur trop grosse, la d√©couper
                        if (Object.keys(currentChunk).length > 0) {
                            chunks.push(currentChunk);
                            currentChunk = {};
                            currentSize = 0;
                        }
                        const subChunks = splitLargeData(value, maxSize);
                        subChunks.forEach((sc, i) => {
                            chunks.push({ [`${key}__part${i}`]: sc, _partOf: key, _partIndex: i, _totalParts: subChunks.length });
                        });
                    } else if (currentSize + valueStr.length > maxSize && Object.keys(currentChunk).length > 0) {
                        chunks.push(currentChunk);
                        currentChunk = { [key]: value };
                        currentSize = valueStr.length;
                    } else {
                        currentChunk[key] = value;
                        currentSize += valueStr.length;
                    }
                }
                if (Object.keys(currentChunk).length > 0) chunks.push(currentChunk);
                return chunks;
            }

            // Sinon retourner tel quel
            return [data];
        }

        // Migration par modules (pour gros volumes)
        async function migrateByModules(data) {
            const modules = Object.keys(data).filter(k =>
                k !== 'lastUpdated' && k !== 'lastUpdatedBy'
            );

            const totalModules = modules.length;
            let migratedCount = 0;
            const MAX_DOC_SIZE = 800000; // 800KB pour √™tre safe (limite = 1MB)
            const MAX_ARRAY_CHUNK = 100; // Nombre d'√©l√©ments par chunk pour les tableaux

            // D'abord cr√©er le document principal avec les m√©tadonn√©es
            const mainDoc = {
                lastUpdated: data.lastUpdated,
                lastUpdatedBy: data.lastUpdatedBy,
                _chunkedModules: [] // Liste des modules d√©coup√©s
            };

            // Ajouter les petits modules au document principal (sanitized)
            for (const moduleName of modules) {
                const moduleData = data[moduleName];
                const moduleSize = JSON.stringify(moduleData || null).length;

                if (moduleSize < 50000) { // Moins de 50KB
                    mainDoc[moduleName] = sanitizeForFirestore(moduleData);
                    log(`üì¶ ${moduleName}: inclus dans le document principal`, 'info');
                }

                migratedCount++;
                progressBar.style.width = `${(migratedCount / totalModules) * 50}%`;
            }

            // Sauvegarder le document principal
            const mainDocRef = doc(db, 'applicationData', 'mainData');
            await setDoc(mainDocRef, mainDoc);
            log('‚úÖ Document principal cr√©√©', 'success');

            // Migrer les gros modules s√©par√©ment (avec d√©coupage si n√©cessaire)
            let processedLarge = 0;
            const largeModules = modules.filter(m => {
                const size = JSON.stringify(data[m] || null).length;
                return size >= 50000;
            });

            for (const moduleName of largeModules) {
                const moduleData = data[moduleName];
                const moduleSize = JSON.stringify(moduleData || null).length;

                if (moduleSize > MAX_DOC_SIZE) {
                    // Module trop gros - utiliser la fonction de d√©coupage r√©cursif
                    log(`‚ö†Ô∏è ${moduleName}: trop volumineux (${(moduleSize/1024/1024).toFixed(2)} MB), d√©coupage...`, 'warning');

                    const chunks = splitLargeData(moduleData, MAX_DOC_SIZE - 50000); // Marge de s√©curit√©

                    log(`   ‚Üí D√©coupage en ${chunks.length} parties`, 'info');

                    // Sauvegarder chaque chunk (sanitized)
                    for (let i = 0; i < chunks.length; i++) {
                        const sanitizedChunk = sanitizeForFirestore(chunks[i]);
                        const chunkSize = JSON.stringify(sanitizedChunk).length;
                        const chunkRef = doc(db, 'applicationData', `${moduleName}_chunk_${i}`);
                        await setDoc(chunkRef, {
                            data: sanitizedChunk,
                            chunkIndex: i,
                            totalChunks: chunks.length,
                            moduleName: moduleName,
                            updatedAt: new Date().toISOString()
                        });
                        log(`   ‚Üí Chunk ${i+1}/${chunks.length} sauvegard√© (${(chunkSize/1024).toFixed(0)} KB)`, 'info');
                    }

                    // Marquer ce module comme d√©coup√©
                    mainDoc._chunkedModules.push({
                        name: moduleName,
                        chunks: chunks.length,
                        type: Array.isArray(moduleData) ? 'array' : 'object'
                    });
                } else {
                    // Module de taille acceptable - sanitize pour Firestore
                    const sanitizedData = sanitizeForFirestore(moduleData);
                    const moduleDocRef = doc(db, 'applicationData', `module_${moduleName}`);
                    await setDoc(moduleDocRef, { data: sanitizedData, updatedAt: new Date().toISOString() });
                    log(`üì¶ ${moduleName}: migr√© s√©par√©ment (${(moduleSize/1024).toFixed(1)} KB)`, 'success');
                }

                processedLarge++;
                progressBar.style.width = `${50 + (processedLarge / largeModules.length) * 50}%`;
            }

            // Mettre √† jour le document principal avec la liste des modules d√©coup√©s
            if (mainDoc._chunkedModules.length > 0) {
                await setDoc(mainDocRef, mainDoc);
                log(`‚ÑπÔ∏è ${mainDoc._chunkedModules.length} modules ont √©t√© d√©coup√©s`, 'info');
            }

            progressBar.style.width = '100%';
            log('‚úÖ Migration compl√®te termin√©e!', 'success');
        }
    </script>
</body>
</html>
