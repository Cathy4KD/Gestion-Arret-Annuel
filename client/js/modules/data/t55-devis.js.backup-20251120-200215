/**
 * @fileoverview Module de gestion des Devis et Corrections (T55)
 * @module data/t55-devis
 */

import { saveToStorage, loadFromStorage } from '../sync/storage-wrapper.js';

let t55Data = {
    entrepreneurs: {}, // { entrepreneurName: { toutes les donn√©es du formulaire } }
    currentEntrepreneur: '' // Dernier entrepreneur s√©lectionn√© (sauvegard√© sur serveur)
};

let currentEntrepreneur = '';

/**
 * Set T55 data (utilis√© par server-sync pour injecter les donn√©es)
 */
export function setT55Data(data) {
    t55Data = data || { entrepreneurs: {} };
    console.log('[T55] ‚úÖ Donn√©es inject√©es');
}

/**
 * Set T55 entrepreneurs list (utilis√© par server-sync pour injecter la liste)
 */
export function setT55EntrepreneursList(data) {
    if (data && Array.isArray(data) && data.length > 0) {
        console.log('[T55] ‚úÖ Liste entrepreneurs inject√©e:', data.length, 'entrepreneurs');
        populateEntrepreneursSelect(data);
    } else {
        console.log('[T55] ‚ö†Ô∏è Aucune liste entrepreneurs re√ßue du serveur');
    }
}

// Exposer globalement
if (typeof window !== 'undefined') {
    window.setT55Data = setT55Data;
    window.setT55EntrepreneursList = setT55EntrepreneursList;
}

export async function loadT55Data() {
    const saved = await loadFromStorage('t55Data');
    if (saved) {
        t55Data = saved;
        // S'assurer que la structure est compl√®te
        if (!t55Data.entrepreneurs) t55Data.entrepreneurs = {};
        if (!t55Data.currentEntrepreneur) t55Data.currentEntrepreneur = '';
        console.log('[T55] Donn√©es T55 charg√©es depuis le serveur');
    } else {
        t55Data = {
            entrepreneurs: {},
            currentEntrepreneur: ''
        };
        console.log('[T55] Aucune donn√©e T55 trouv√©e, initialisation');
    }

    // Charger la liste des entrepreneurs sauvegard√©e depuis le serveur
    await loadEntrepreneursList();
}

export async function saveT55Data() {
    if (!currentEntrepreneur) return;

    // R√©cup√©rer toutes les valeurs du formulaire
    const entrepreneurData = {
        // Informations g√©n√©rales
        titreDevis: document.getElementById('t55TitreDevis')?.value || 'Devis g√©n√©ral',
        specialite: document.getElementById('t55Specialite')?.value || '',
        lieu: document.getElementById('t55Lieu')?.value || '',
        typeContrat: document.getElementById('t55TypeContrat')?.value || '',

        // Personnes responsables
        responsable: document.getElementById('t55Responsable')?.value || '',
        verificateur: document.getElementById('t55Verificateur')?.value || '',
        approbateur: document.getElementById('t55Approbateur')?.value || '',

        // Dates cl√©s
        dates: {
            debutVisites: document.getElementById('t55DateDebutVisites')?.value || '',
            remiseSoumission: document.getElementById('t55DateRemiseSoumission')?.value || '',
            adjudication: document.getElementById('t55DateAdjudication')?.value || '',
            listeCognibox: document.getElementById('t55DateListeCognibox')?.value || '',
            debutMobilisation: document.getElementById('t55DateDebutMobilisation')?.value || '',
            finMobilisation: document.getElementById('t55DateFinMobilisation')?.value || '',
            debutArret: document.getElementById('t55DateDebutArret')?.value || '',
            finArret: document.getElementById('t55DateFinArret')?.value || '',
            demobilisation: document.getElementById('t55DateDemobilisation')?.value || '',
            verification: document.getElementById('t55DateVerification')?.value || '',
            approbation: document.getElementById('t55DateApprobation')?.value || ''
        },

        // Tableaux
        dessins: getDessinsTableData(),
        convertisseur: getConvertisseurTableData(),
        couleeContinue: getCouleeContinueTableData(),
        // historique: getHistoriqueTableData(), // NON UTILIS√â POUR LA G√âN√âRATION DOCX

        // Remarques
        remarquesGenerales: document.getElementById('t55RemarquesGenerales')?.value || '',
        corrections: document.getElementById('t55Corrections')?.value || '',

        lastUpdated: new Date().toISOString()
    };

    t55Data.entrepreneurs[currentEntrepreneur] = entrepreneurData;
    await saveToStorage('t55Data', t55Data);
    console.log('[T55] Donn√©es sauvegard√©es sur le serveur pour', currentEntrepreneur);
}

function getDessinsTableData() {
    const tbody = document.getElementById('t55DessinsTableBody');
    if (!tbody) return [];

    const dessins = [];
    const rows = tbody.querySelectorAll('tr');

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input, textarea');
        if (inputs.length >= 3) {
            dessins.push({
                numero: inputs[0].value || '',
                revision: inputs[1].value || '',
                titre: inputs[2].value || ''
            });
        }
    });

    return dessins;
}

function getConvertisseurTableData() {
    const tbody = document.getElementById('t55ConvertisseurTableBody');
    if (!tbody) return [];

    const convertisseur = [];
    const rows = tbody.querySelectorAll('tr');

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input, textarea');
        if (inputs.length >= 7) {
            convertisseur.push({
                item: inputs[0].value || '',
                equipement: inputs[1].value || '',
                ordre: inputs[2].value || '',
                description: inputs[3].value || '',
                materielRTFT: inputs[4].value || '',
                materielEntrepreneur: inputs[5].value || '',
                dessinsRef: inputs[6].value || ''
            });
        }
    });

    return convertisseur;
}

function getCouleeContinueTableData() {
    const tbody = document.getElementById('t55CouleeContinueTableBody');
    if (!tbody) return [];

    const couleeContinue = [];
    const rows = tbody.querySelectorAll('tr');

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input, textarea');
        if (inputs.length >= 7) {
            couleeContinue.push({
                item: inputs[0].value || '',
                equipement: inputs[1].value || '',
                ordre: inputs[2].value || '',
                description: inputs[3].value || '',
                materielRTFT: inputs[4].value || '',
                materielEntrepreneur: inputs[5].value || '',
                dessinsRef: inputs[6].value || ''
            });
        }
    });

    return couleeContinue;
}

function getHistoriqueTableData() {
    const tbody = document.getElementById('t55HistoriqueTableBody');
    if (!tbody) return [];

    const historique = [];
    const rows = tbody.querySelectorAll('tr');

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input, textarea');
        if (inputs.length >= 11) {
            historique.push({
                occ: inputs[0].value || '',
                revision: inputs[1].value || '',
                item: inputs[2].value || '',
                equipement: inputs[3].value || '',
                ordre: inputs[4].value || '',
                description: inputs[5].value || '',
                materielRTFT: inputs[6].value || '',
                materielEntrepreneur: inputs[7].value || '',
                dessinsRef: inputs[8].value || '',
                gammes: inputs[9].value || '',
                cptrGrpGam: inputs[10].value || ''
            });
        }
    });

    return historique;
}

/**
 * Charge la liste des entrepreneurs depuis le storage
 */
async function loadEntrepreneursList() {
    const saved = await loadFromStorage('t55EntrepreneursList');

    if (saved && Array.isArray(saved) && saved.length > 0) {
        console.log('[T55] ‚úÖ Liste des entrepreneurs charg√©e depuis le serveur:', saved.length, 'entrepreneurs');
        console.log('[T55] Entrepreneurs:', saved);

        // Attendre que le DOM soit pr√™t et r√©essayer si n√©cessaire
        let attempts = 0;
        const maxAttempts = 20; // Augment√© √† 20 tentatives
        const retryInterval = 200; // Augment√© √† 200ms entre chaque tentative

        const tryPopulate = () => {
            attempts++;
            const select = document.getElementById('t55EntrepreneurSelect');

            if (select) {
                console.log(`[T55] ‚úÖ Select trouv√© apr√®s ${attempts} tentative(s), peuplement en cours...`);
                populateEntrepreneursSelect(saved);
                console.log('[T55] ‚úÖ Menu d√©roulant peupl√© avec', select.options.length - 1, 'entrepreneurs');

                // Afficher un indicateur visuel que la liste a √©t√© charg√©e
                if (select.options.length > 1) {
                    const syncBtn = document.querySelector('button[onclick="syncT55Entrepreneurs()"]');
                    if (syncBtn) {
                        syncBtn.innerHTML = '‚úÖ Liste sauvegard√©e';
                        syncBtn.style.background = '#28a745';
                        setTimeout(() => {
                            syncBtn.innerHTML = 'üîÑ Synchroniser IW37N';
                            syncBtn.style.background = '#4a7c59';
                        }, 3000);
                    }
                }
            } else {
                if (attempts < maxAttempts) {
                    console.log(`[T55] ‚ö†Ô∏è Select non trouv√©, tentative ${attempts}/${maxAttempts}, nouvelle tentative dans ${retryInterval}ms...`);
                    setTimeout(tryPopulate, retryInterval);
                } else {
                    console.error(`[T55] ‚ùå √âCHEC: Select t55EntrepreneurSelect introuvable apr√®s ${maxAttempts} tentatives (${maxAttempts * retryInterval}ms)`);
                    console.error('[T55] ‚ùå V√©rifiez que vous √™tes bien sur la page detail-t55');
                }
            }
        };

        tryPopulate();
    } else {
        console.log('[T55] ‚ö†Ô∏è Aucune liste d\'entrepreneurs sauvegard√©e. Cliquez sur "Synchroniser IW37N".');
    }
}

/**
 * R√©cup√®re le nom d'un code externe depuis les donn√©es contacts
 * @param {string} code - Code externe
 * @returns {string} Nom correspondant ou cha√Æne vide
 */
function getCodeExterneName(code) {
    try {
        if (typeof window.getCodesExternes === 'function') {
            const codesExternes = window.getCodesExternes();
            const codeData = codesExternes.find(c => c.code === code);
            return codeData ? codeData.nom : '';
        }
    } catch (error) {
        console.warn('[T55] Erreur r√©cup√©ration nom code externe:', error);
    }
    return '';
}

/**
 * Remplit le menu d√©roulant des entrepreneurs
 */
function populateEntrepreneursSelect(entrepreneursList) {
    const select = document.getElementById('t55EntrepreneurSelect');
    if (!select) return;

    select.innerHTML = '<option value="">-- S√©lectionner un entrepreneur --</option>';

    entrepreneursList.forEach(entrepreneur => {
        const option = document.createElement('option');
        option.value = entrepreneur;

        // Afficher "CODE - Nom" si le nom existe, sinon juste le code
        const codeName = getCodeExterneName(entrepreneur);
        option.textContent = codeName ? `${entrepreneur} - ${codeName}` : entrepreneur;

        select.appendChild(option);
    });

    console.log('[T55] Menu d√©roulant rempli avec', entrepreneursList.length, 'entrepreneurs');

    // Mettre √† jour le statut visuel
    const statusDiv = document.getElementById('t55EntrepreneursListStatus');
    if (statusDiv) {
        statusDiv.innerHTML = `‚úÖ <strong style="color: #28a745;">${entrepreneursList.length} entrepreneur(s)</strong> disponible(s)`;
    }
}

export async function syncT55Entrepreneurs() {
    console.log('[T55] Synchronisation des entrepreneurs depuis IW37N...');

    const iw37nData = await loadFromStorage('iw37nData');

    if (!iw37nData || !Array.isArray(iw37nData) || iw37nData.length === 0) {
        alert('‚ö†Ô∏è Aucune donn√©e IW37N trouv√©e. Veuillez d\'abord importer les donn√©es IW37N.');
        return;
    }

    console.log('[T55] Nombre de lignes IW37N √† traiter:', iw37nData.length);

    try {
        const entrepreneursSet = new Set();
        const allValuesSet = new Set();

        iw37nData.forEach(row => {
            const posteTravOper = row['Post.trav.op√©r.'] || row['Post.trav.oper.'] || row['PosteTravOper'] || '';
            const posteTravOperStr = posteTravOper.toString().trim();

            if (posteTravOperStr) {
                allValuesSet.add(posteTravOperStr);
            }

            if (posteTravOperStr &&
                posteTravOperStr !== '-' &&
                !posteTravOperStr.toUpperCase().startsWith('A') &&
                !posteTravOperStr.toUpperCase().startsWith('E')) {
                entrepreneursSet.add(posteTravOperStr);
            }
        });

        const allValuesArray = Array.from(allValuesSet).sort();
        console.log('[T55] TOUTES les valeurs Post.trav.op√©r. trouv√©es:', allValuesArray);
        console.log('[T55] Nombre total de valeurs uniques:', allValuesArray.length);

        const entrepreneursArray = Array.from(entrepreneursSet).sort();

        console.log(`[T55] ${entrepreneursArray.length} entrepreneurs trouv√©s (apr√®s filtre A/E)`);
        console.log('[T55] Entrepreneurs trouv√©s:', entrepreneursArray);

        if (entrepreneursArray.length === 0) {
            console.warn('[T55] ‚ö†Ô∏è AUCUN entrepreneur trouv√© apr√®s avoir exclu ceux commen√ßant par A ou E!');
            alert('‚ö†Ô∏è Aucun entrepreneur trouv√© dans Post.trav.op√©r. apr√®s avoir exclu ceux commen√ßant par A ou E.\n\n' +
                  'V√©rifiez que votre fichier IW37N contient bien des valeurs dans la colonne "Post.trav.op√©r." qui ne commencent pas par A ou E (ex: MECEXT, COH, INC, etc.)');
            return;
        }

        // Charger la liste existante et fusionner avec les nouvelles valeurs
        const existingList = await loadFromStorage('t55EntrepreneursList') || [];
        console.log('[T55] Entrepreneurs existants en m√©moire:', existingList);

        // Cr√©er un Set combin√© pour √©viter les doublons
        const mergedSet = new Set([...existingList, ...entrepreneursArray]);
        const mergedArray = Array.from(mergedSet).sort();

        const newEntrepreneurs = entrepreneursArray.filter(e => !existingList.includes(e));
        console.log('[T55] Nouveaux entrepreneurs ajout√©s:', newEntrepreneurs.length > 0 ? newEntrepreneurs : 'aucun');

        // Sauvegarder la liste fusionn√©e des entrepreneurs sur le serveur
        await saveToStorage('t55EntrepreneursList', mergedArray);
        console.log('[T55] ‚úÖ Liste des entrepreneurs fusionn√©e et sauvegard√©e sur le serveur');

        // Remplir le menu d√©roulant avec la liste fusionn√©e
        populateEntrepreneursSelect(mergedArray);

        // V√©rifier que la sauvegarde a bien fonctionn√©
        const verif = await loadFromStorage('t55EntrepreneursList');
        if (verif && verif.length === mergedArray.length) {
            console.log('[T55] ‚úÖ V√©rification : Liste correctement sauvegard√©e sur le serveur');
            console.log('[T55] ‚úÖ La liste sera maintenant disponible apr√®s un refresh (F5)');
        } else {
            console.error('[T55] ‚ùå PROBL√àME : Sauvegarde √©chou√©e! Liste non disponible apr√®s refresh.');
        }

        if (newEntrepreneurs.length > 0) {
            alert(`‚úÖ Synchronisation termin√©e!\n\n` +
                  `üìä Total: ${mergedArray.length} entrepreneurs\n` +
                  `‚ú® Nouveaux: ${newEntrepreneurs.length} entrepreneurs ajout√©s\n\n` +
                  `Nouveaux entrepreneurs: ${newEntrepreneurs.join(', ')}\n\n` +
                  `üíæ La liste reste en m√©moire et les nouvelles valeurs ont √©t√© ajout√©es.`);
        } else {
            alert(`‚úÖ Synchronisation termin√©e!\n\n` +
                  `üìä Total: ${mergedArray.length} entrepreneurs\n` +
                  `‚ÑπÔ∏è Aucun nouvel entrepreneur (tous d√©j√† en m√©moire)\n\n` +
                  `üíæ La liste reste inchang√©e.`);
        }

    } catch (error) {
        console.error('[T55] Erreur lors de la synchronisation:', error);
        alert('‚ùå Erreur lors de la synchronisation avec IW37N.');
    }
}

export async function loadT55EntrepreneurData() {
    console.log('[T55] loadT55EntrepreneurData() appel√©e');

    const select = document.getElementById('t55EntrepreneurSelect');
    if (!select) {
        console.error('[T55] √âl√©ment t55EntrepreneurSelect introuvable');
        return;
    }

    currentEntrepreneur = select.value;
    console.log('[T55] Entrepreneur s√©lectionn√©:', currentEntrepreneur);

    // Sauvegarder la s√©lection sur le serveur pour la recharger apr√®s un refresh
    t55Data.currentEntrepreneur = currentEntrepreneur;
    await saveToStorage('t55Data', t55Data);

    const devisForm = document.getElementById('t55DevisForm');
    const exportBtn = document.getElementById('t55ExportDOCXBtn');

    if (!currentEntrepreneur) {
        console.log('[T55] Aucun entrepreneur s√©lectionn√©, masquage du formulaire');
        if (devisForm) devisForm.style.display = 'none';
        if (exportBtn) exportBtn.style.display = 'none';
        return;
    }

    console.log('[T55] Affichage du formulaire');
    if (devisForm) {
        devisForm.style.display = 'block';
        console.log('[T55] Formulaire affich√©');
    } else {
        console.error('[T55] √âl√©ment t55DevisForm introuvable!');
    }
    if (exportBtn) exportBtn.style.display = 'block';

    // Masquer la section Historique des Devis et Corrections pour les entrepreneurs
    const historiqueSection = document.getElementById('t55HistoriqueSection');
    if (historiqueSection) {
        historiqueSection.style.display = 'none';
        console.log('[T55] Section Historique masqu√©e (non utilis√©e pour les entrepreneurs)');
    }

    const entrepreneurData = t55Data.entrepreneurs[currentEntrepreneur] || {};
    console.log('[T55] Donn√©es entrepreneur:', entrepreneurData);

    // Charger les donn√©es - avec v√©rifications de s√©curit√©
    const titreDevis = document.getElementById('t55TitreDevis');
    const specialite = document.getElementById('t55Specialite');
    const lieu = document.getElementById('t55Lieu');
    const typeContrat = document.getElementById('t55TypeContrat');

    if (titreDevis) titreDevis.value = entrepreneurData.titreDevis || 'Devis g√©n√©ral';
    if (specialite) specialite.value = entrepreneurData.specialite || '';
    if (lieu) lieu.value = entrepreneurData.lieu || 'Rio Tinto Fer et Titane, Sorel-Tracy, Qu√©bec, Canada';
    if (typeContrat) typeContrat.value = entrepreneurData.typeContrat || 'D√©penses contr√¥l√©es';

    // Charger les personnes responsables
    const responsable = document.getElementById('t55Responsable');
    const verificateur = document.getElementById('t55Verificateur');
    const approbateur = document.getElementById('t55Approbateur');

    if (responsable) responsable.value = entrepreneurData.responsable || '';
    if (verificateur) verificateur.value = entrepreneurData.verificateur || '';
    if (approbateur) approbateur.value = entrepreneurData.approbateur || '';

    if (entrepreneurData.dates) {
        const dateDebutVisites = document.getElementById('t55DateDebutVisites');
        const dateRemiseSoumission = document.getElementById('t55DateRemiseSoumission');
        const dateAdjudication = document.getElementById('t55DateAdjudication');
        const dateListeCognibox = document.getElementById('t55DateListeCognibox');
        const dateDebutMobilisation = document.getElementById('t55DateDebutMobilisation');
        const dateFinMobilisation = document.getElementById('t55DateFinMobilisation');
        const dateDebutArret = document.getElementById('t55DateDebutArret');
        const dateFinArret = document.getElementById('t55DateFinArret');
        const dateDemobilisation = document.getElementById('t55DateDemobilisation');
        const dateVerification = document.getElementById('t55DateVerification');
        const dateApprobation = document.getElementById('t55DateApprobation');

        if (dateDebutVisites) dateDebutVisites.value = entrepreneurData.dates.debutVisites || '';
        if (dateRemiseSoumission) dateRemiseSoumission.value = entrepreneurData.dates.remiseSoumission || '';
        if (dateAdjudication) dateAdjudication.value = entrepreneurData.dates.adjudication || '';
        if (dateListeCognibox) dateListeCognibox.value = entrepreneurData.dates.listeCognibox || '';
        if (dateDebutMobilisation) dateDebutMobilisation.value = entrepreneurData.dates.debutMobilisation || '';
        if (dateFinMobilisation) dateFinMobilisation.value = entrepreneurData.dates.finMobilisation || '';
        if (dateDebutArret) dateDebutArret.value = entrepreneurData.dates.debutArret || '';
        if (dateFinArret) dateFinArret.value = entrepreneurData.dates.finArret || '';
        if (dateDemobilisation) dateDemobilisation.value = entrepreneurData.dates.demobilisation || '';
        if (dateVerification) dateVerification.value = entrepreneurData.dates.verification || '';
        if (dateApprobation) dateApprobation.value = entrepreneurData.dates.approbation || '';
    }

    const remarquesGenerales = document.getElementById('t55RemarquesGenerales');
    const corrections = document.getElementById('t55Corrections');

    if (remarquesGenerales) remarquesGenerales.value = entrepreneurData.remarquesGenerales || '';
    if (corrections) corrections.value = entrepreneurData.corrections || '';

    console.log('[T55] Rendu des tableaux...');
    renderDessinsTable(entrepreneurData.dessins || []);

    // Charger automatiquement les donn√©es depuis IW37N et Historique
    await autoFillFromIW37NAndHistorique();

    // Recharger les donn√©es apr√®s l'auto-fill
    const updatedData = t55Data.entrepreneurs[currentEntrepreneur] || {};

    renderConvertisseurTable(updatedData.convertisseur || []);
    renderCouleeContinueTable(updatedData.couleeContinue || []);
    // renderHistoriqueTable(updatedData.historique || []); // NON UTILIS√â POUR LA G√âN√âRATION DOCX
    console.log('[T55] Tableaux rendus avec succ√®s');
}

/**
 * Remplit automatiquement les tableaux Convertisseur et Coul√©e Continue
 * en se basant sur IW37N (filtre par Post.trav.op√©r.) et Historique (colonnes Gammes et R√©vision)
 */
async function autoFillFromIW37NAndHistorique() {
    if (!currentEntrepreneur) {
        console.log('[T55] Aucun entrepreneur s√©lectionn√©, skip auto-fill');
        return;
    }

    console.log('[T55] üîÑ Auto-remplissage depuis IW37N et Historique pour:', currentEntrepreneur);

    try {
        // 1. Charger les donn√©es IW37N
        const iw37nData = await loadFromStorage('iw37nData');
        if (!iw37nData || !Array.isArray(iw37nData)) {
            console.warn('[T55] ‚ö†Ô∏è Aucune donn√©e IW37N disponible');
            return;
        }
        console.log('[T55] ‚úÖ IW37N charg√©:', iw37nData.length, 'lignes');

        // 2. Charger les donn√©es de l'historique T55
        const historiqueData = await loadFromStorage('t55HistoriqueData');
        if (!historiqueData || !Array.isArray(historiqueData)) {
            console.warn('[T55] ‚ö†Ô∏è Aucune donn√©e Historique disponible');
            return;
        }
        console.log('[T55] ‚úÖ Historique T55 charg√©:', historiqueData.length, 'entr√©es');

        // 3. Filtrer IW37N par Post.trav.op√©r. (entrepreneur s√©lectionn√©)
        console.log('[T55] üîç Filtrage IW37N pour entrepreneur:', currentEntrepreneur);
        console.log('[T55] üîç Exemple de premi√®re ligne IW37N:', iw37nData[0]);

        const ordresEntrepreneur = iw37nData.filter(ligne => {
            const posteTrav = (ligne['Post.trav.op√©r.'] || ligne.posteTravOper || '').toString().trim();
            const match = posteTrav === currentEntrepreneur;

            // Log pour debug (seulement les 5 premi√®res lignes)
            if (iw37nData.indexOf(ligne) < 5) {
                console.log('[T55] üîç Ligne', iw37nData.indexOf(ligne), '- Post.trav.op√©r.:', `"${posteTrav}"`, '- Match:', match);
            }

            return match;
        });
        console.log('[T55] üìã Ordres filtr√©s pour', currentEntrepreneur, ':', ordresEntrepreneur.length);

        if (ordresEntrepreneur.length > 0) {
            console.log('[T55] üìã Exemple premier ordre filtr√©:', ordresEntrepreneur[0]);
        }

        if (ordresEntrepreneur.length === 0) {
            console.log('[T55] ‚ö†Ô∏è Aucun ordre trouv√© pour cet entrepreneur dans IW37N');
            alert(`‚ö†Ô∏è Aucun ordre trouv√© dans IW37N pour l'entrepreneur: ${currentEntrepreneur}\n\nV√©rifiez que:\n1. Les donn√©es IW37N sont bien charg√©es\n2. La colonne "Post.trav.op√©r." contient bien "${currentEntrepreneur}"`);
            return;
        }

        // 4. √âTAPE 2: D√©dupliquer les ordres et faire le matching avec Historique
        const convertisseurData = [];
        const couleeContinueData = [];
        const ordresTraites = new Set(); // Pour √©viter les doublons

        console.log('[T55] üìù Traitement des ordres avec matching Historique...');

        ordresEntrepreneur.forEach((ordreIW37N, index) => {
            const numeroOrdre = (ordreIW37N['Ordre'] || ordreIW37N.ordre || '').toString().trim();
            const designation = ordreIW37N['D√©signation'] || ordreIW37N.designation || '';

            // Utiliser "Grpe de gammes" au lieu de "Gamme"
            const gammeIW37N = (ordreIW37N['Grpe de gammes'] || ordreIW37N['Grpe de Gammes'] || ordreIW37N.grpeDeGammes || '').toString().trim();

            // CORRECTION: R√©cup√©rer la r√©vision depuis IW37N, pas depuis Historique
            const revisionIW37N = (ordreIW37N['R√©vision'] || ordreIW37N.revision || '').toString().trim().toUpperCase();

            // Ignorer si d√©j√† trait√© (√©vite les doublons)
            if (ordresTraites.has(numeroOrdre)) {
                return;
            }
            ordresTraites.add(numeroOrdre);

            if (index < 5) {
                console.log(`[T55] üìù Ordre ${index + 1}:`, {
                    ordre: numeroOrdre,
                    designation: designation,
                    grpeDeGammes: gammeIW37N,
                    revision: revisionIW37N
                });
            }

            // Chercher dans l'historique via le num√©ro de Grpe de Gammes (pour r√©cup√©rer les autres infos)
            let entreeHistorique = null;

            if (gammeIW37N) {
                // Chercher correspondance exacte par Gammes dans l'Historique
                entreeHistorique = historiqueData.find(h => {
                    const gammes = (h.gammes || h.Gammes || '').toString().trim();
                    return gammes === gammeIW37N;
                });

                if (entreeHistorique) {
                    if (index < 5) {
                        console.log(`[T55]   ‚úÖ Match Historique trouv√© pour Grpe de Gammes: ${gammeIW37N}`);
                        console.log(`[T55]      - Item: ${entreeHistorique.item}`);
                        console.log(`[T55]      - √âquipement: ${entreeHistorique.equipement || entreeHistorique.√âquipement}`);
                        console.log(`[T55]      - Description: ${entreeHistorique.descriptionTravaux || entreeHistorique['Description des travaux']}`);
                        console.log(`[T55]      - Mat√©riel RTFT: ${entreeHistorique.materielRTFT || entreeHistorique['Mat√©riel fournis par RTFT']}`);
                        console.log(`[T55]      - Mat√©riel Entrepreneur: ${entreeHistorique.materielEntrepreneur || entreeHistorique['Mat√©riel fournis par Entrepreneur']}`);
                        console.log(`[T55]      - Dessins/R√©f: ${entreeHistorique.dessinsReferences || entreeHistorique['Dessins - R√©f√©rences']}`);
                    }
                } else {
                    if (index < 5) {
                        console.log(`[T55]   ‚ö†Ô∏è Pas de match Historique pour Grpe de Gammes: "${gammeIW37N}"`);
                        // Afficher les 3 premi√®res gammes de l'historique pour debug
                        console.log(`[T55]      Exemples Gammes Historique:`, historiqueData.slice(0, 3).map(h => h.gammes || h.Gammes));
                    }
                }
            } else {
                if (index < 5) {
                    console.log(`[T55]   ‚ö†Ô∏è Pas de num√©ro de Grpe de Gammes dans IW37N pour cet ordre`);
                }
            }

            // Cr√©er l'objet de travail avec donn√©es de l'Historique si match trouv√©
            const travail = {
                item: entreeHistorique ? (entreeHistorique.item || '') : '',
                equipement: entreeHistorique ? (entreeHistorique.equipement || entreeHistorique.√âquipement || '') : '',
                ordre: numeroOrdre,
                description: entreeHistorique ? (entreeHistorique.descriptionTravaux || entreeHistorique['Description des travaux'] || designation) : designation,
                materielRTFT: entreeHistorique ? (entreeHistorique.materielRTFT || entreeHistorique['Mat√©riel fournis par RTFT'] || '') : '',
                materielEntrepreneur: entreeHistorique ? (entreeHistorique.materielEntrepreneur || entreeHistorique['Mat√©riel fournis par Entrepreneur'] || '') : '',
                dessinsRef: entreeHistorique ? (entreeHistorique.dessinsReferences || entreeHistorique['Dessins - R√©f√©rences'] || '') : ''
            };

            // Log pour v√©rifier les donn√©es remplies
            if (index < 5) {
                console.log(`[T55]   üìã Travail cr√©√©:`, travail);
            }

            // Dispatcher selon la r√©vision d'IW37N
            if (revisionIW37N.startsWith('ACI')) {
                convertisseurData.push(travail);
                if (index < 5) {
                    console.log(`[T55]   ‚û°Ô∏è CONVERTISSEUR (R√©vision: ${revisionIW37N})`);
                }
            } else if (revisionIW37N.startsWith('ACC')) {
                couleeContinueData.push(travail);
                if (index < 5) {
                    console.log(`[T55]   ‚û°Ô∏è COUL√âE CONTINUE (R√©vision: ${revisionIW37N})`);
                }
            } else {
                // Si pas de r√©vision ou r√©vision inconnue, mettre dans Convertisseur par d√©faut
                convertisseurData.push(travail);
                if (index < 5) {
                    console.log(`[T55]   ‚ö†Ô∏è R√©vision inconnue (${revisionIW37N}), ajout√© √† Convertisseur par d√©faut`);
                }
            }
        });

        console.log('[T55] ‚úÖ Traitement termin√©:');
        console.log('[T55]   - Total ordres trouv√©s:', ordresEntrepreneur.length);
        console.log('[T55]   - Ordres uniques trait√©s:', ordresTraites.size);
        console.log('[T55]   - CONVERTISSEUR (ACI):', convertisseurData.length);
        console.log('[T55]   - COUL√âE CONTINUE (ACC):', couleeContinueData.length);

        // Informer l'utilisateur
        if (convertisseurData.length > 0) {
            console.log(`[T55] ‚úÖ ${convertisseurData.length} ordre(s) charg√©(s) pour ${currentEntrepreneur}`);
        }

        // 5. Sauvegarder dans les donn√©es de l'entrepreneur
        if (!t55Data.entrepreneurs[currentEntrepreneur]) {
            t55Data.entrepreneurs[currentEntrepreneur] = {};
        }
        t55Data.entrepreneurs[currentEntrepreneur].convertisseur = convertisseurData;
        t55Data.entrepreneurs[currentEntrepreneur].couleeContinue = couleeContinueData;

        // Sauvegarder sur le serveur
        await saveToStorage('t55Data', t55Data);
        console.log('[T55] üíæ Donn√©es auto-remplies sauvegard√©es sur le serveur');

    } catch (error) {
        console.error('[T55] ‚ùå Erreur lors de l\'auto-remplissage:', error);
    }
}

function renderDessinsTable(dessins) {
    console.log('[T55] renderDessinsTable() appel√©e avec', dessins.length, 'dessins');
    const tbody = document.getElementById('t55DessinsTableBody');
    if (!tbody) {
        console.error('[T55] √âl√©ment t55DessinsTableBody introuvable!');
        return;
    }

    if (dessins.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">Aucun dessin. Cliquez sur "Ajouter" pour commencer.</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    dessins.forEach((dessin, index) => {
        const row = document.createElement('tr');
        row.style.background = index % 2 === 0 ? 'white' : '#f8f9fa';
        row.innerHTML = `
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${dessin.numero || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${dessin.revision || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${dessin.titre || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                <button onclick="deleteT55DessinRow(this)" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    ‚ùå
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderConvertisseurTable(convertisseur) {
    const tbody = document.getElementById('t55ConvertisseurTableBody');
    if (!tbody) return;

    if (convertisseur.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: #999;">Aucun travail Convertisseur. Cliquez sur "Ajouter" pour commencer.</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    convertisseur.forEach((travail, index) => {
        const row = document.createElement('tr');
        row.style.background = index % 2 === 0 ? 'white' : '#f8f9fa';
        row.innerHTML = `
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.item || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.equipement || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.ordre || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${travail.description || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${travail.materielRTFT || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${travail.materielEntrepreneur || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.dessinsRef || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                <button onclick="deleteT55ConvertisseurRow(this)" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    ‚ùå
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderCouleeContinueTable(couleeContinue) {
    const tbody = document.getElementById('t55CouleeContinueTableBody');
    if (!tbody) return;

    if (couleeContinue.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: #999;">Aucun travail Coul√©e continue. Cliquez sur "Ajouter" pour commencer.</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    couleeContinue.forEach((travail, index) => {
        const row = document.createElement('tr');
        row.style.background = index % 2 === 0 ? 'white' : '#f8f9fa';
        row.innerHTML = `
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.item || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.equipement || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.ordre || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${travail.description || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${travail.materielRTFT || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${travail.materielEntrepreneur || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${travail.dessinsRef || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                <button onclick="deleteT55CouleeContinueRow(this)" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    ‚ùå
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderHistoriqueTable(historique) {
    const tbody = document.getElementById('t55HistoriqueTableBody');
    if (!tbody) return;

    if (historique.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="padding: 20px; text-align: center; color: #999;">Aucune entr√©e. Cliquez sur "Ajouter" pour commencer.</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    historique.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.style.background = index % 2 === 0 ? 'white' : '#f8f9fa';
        row.innerHTML = `
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.occ || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.revision || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.item || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.equipement || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.ordre || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${entry.description || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${entry.materielRTFT || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <textarea onchange="saveT55Data()" rows="2"
                          style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical;">${entry.materielEntrepreneur || ''}</textarea>
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.dessinsRef || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.gammes || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6;">
                <input type="text" value="${entry.cptrGrpGam || ''}" onchange="saveT55Data()"
                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
            </td>
            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                <button onclick="deleteT55HistoriqueRow(this)" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    ‚ùå
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

export async function addT55DessinRow() {
    if (!currentEntrepreneur) {
        alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un entrepreneur');
        return;
    }

    const entrepreneurData = t55Data.entrepreneurs[currentEntrepreneur] || {};
    const dessins = entrepreneurData.dessins || [];

    dessins.push({ numero: '', revision: '', titre: '' });

    entrepreneurData.dessins = dessins;
    t55Data.entrepreneurs[currentEntrepreneur] = entrepreneurData;

    renderDessinsTable(dessins);
    await saveT55Data();
}

export function deleteT55DessinRow(button) {
    if (confirm('Supprimer cette ligne ?')) {
        const row = button.closest('tr');
        row.remove();
        saveT55Data();
    }
}

export async function addT55ConvertisseurRow() {
    if (!currentEntrepreneur) {
        alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un entrepreneur');
        return;
    }

    const entrepreneurData = t55Data.entrepreneurs[currentEntrepreneur] || {};
    const convertisseur = entrepreneurData.convertisseur || [];

    convertisseur.push({ item: '', equipement: '', ordre: '', description: '', materielRTFT: '', materielEntrepreneur: '', dessinsRef: '' });

    entrepreneurData.convertisseur = convertisseur;
    t55Data.entrepreneurs[currentEntrepreneur] = entrepreneurData;

    renderConvertisseurTable(convertisseur);
    await saveT55Data();
}

export function deleteT55ConvertisseurRow(button) {
    if (confirm('Supprimer cette ligne ?')) {
        const row = button.closest('tr');
        row.remove();
        saveT55Data();
    }
}

export async function addT55CouleeContinueRow() {
    if (!currentEntrepreneur) {
        alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un entrepreneur');
        return;
    }

    const entrepreneurData = t55Data.entrepreneurs[currentEntrepreneur] || {};
    const couleeContinue = entrepreneurData.couleeContinue || [];

    couleeContinue.push({ item: '', equipement: '', ordre: '', description: '', materielRTFT: '', materielEntrepreneur: '', dessinsRef: '' });

    entrepreneurData.couleeContinue = couleeContinue;
    t55Data.entrepreneurs[currentEntrepreneur] = entrepreneurData;

    renderCouleeContinueTable(couleeContinue);
    await saveT55Data();
}

export function deleteT55CouleeContinueRow(button) {
    if (confirm('Supprimer cette ligne ?')) {
        const row = button.closest('tr');
        row.remove();
        saveT55Data();
    }
}

export async function addT55HistoriqueRow() {
    if (!currentEntrepreneur) {
        alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un entrepreneur');
        return;
    }

    const entrepreneurData = t55Data.entrepreneurs[currentEntrepreneur] || {};
    const historique = entrepreneurData.historique || [];

    historique.push({
        occ: '',
        revision: '',
        item: '',
        equipement: '',
        ordre: '',
        description: '',
        materielRTFT: '',
        materielEntrepreneur: '',
        dessinsRef: '',
        gammes: '',
        cptrGrpGam: ''
    });

    entrepreneurData.historique = historique;
    t55Data.entrepreneurs[currentEntrepreneur] = entrepreneurData;

    renderHistoriqueTable(historique);
    await saveT55Data();
}

export function deleteT55HistoriqueRow(button) {
    if (confirm('Supprimer cette ligne ?')) {
        const row = button.closest('tr');
        row.remove();
        saveT55Data();
    }
}

export function exportT55ToPDF() {
    if (!currentEntrepreneur) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un entrepreneur');
        return;
    }

    alert('üìÑ Export PDF en cours de d√©veloppement.\n\nPour l\'instant, utilisez Ctrl+P pour imprimer la page.');

    // TODO: Impl√©menter l'export PDF avec jsPDF
    // const { jsPDF } = window.jspdf;
    // const doc = new jsPDF();
    // ...
}

export function getT55Data() {
    return t55Data;
}

/**
 * Upload le template PDF global
 * @param {FileList} files - Fichier PDF
 */
export async function uploadT55PdfTemplate(files) {
    if (!files || files.length === 0) return;

    const file = files[0];
    if (file.type !== 'application/pdf') {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier PDF');
        return;
    }

    try {
        // Lire le fichier comme Data URL
        const reader = new FileReader();
        reader.onload = async (e) => {
            const pdfDataUrl = e.target.result;

            // Sauvegarder le template PDF
            await saveToStorage('t55PdfTemplate', {
                filename: file.name,
                dataUrl: pdfDataUrl,
                uploadDate: new Date().toISOString()
            });

            // Mettre √† jour le statut
            const statusSpan = document.getElementById('t55PdfTemplateStatus');
            if (statusSpan) {
                statusSpan.innerHTML = `‚úÖ <strong style="color: #28a745;">${file.name}</strong> - ${(file.size / 1024).toFixed(1)} KB`;
            }

            alert(`‚úÖ Template PDF "${file.name}" upload√© avec succ√®s !`);
            console.log('[T55] Template PDF upload√©:', file.name);
        };

        reader.readAsDataURL(file);
    } catch (error) {
        console.error('[T55] Erreur lors de l\'upload du template PDF:', error);
        alert('‚ùå Erreur lors de l\'upload du template PDF');
    }
}

/**
 * Charge le statut du template PDF
 */
async function loadPdfTemplateStatus() {
    const template = await loadFromStorage('t55PdfTemplate');
    const statusSpan = document.getElementById('t55PdfTemplateStatus');

    if (template && statusSpan) {
        const size = template.dataUrl ? (template.dataUrl.length * 0.75 / 1024).toFixed(1) : 0;
        statusSpan.innerHTML = `‚úÖ <strong style="color: #28a745;">${template.filename}</strong> - ${size} KB`;
        console.log('[T55] Template PDF charg√©:', template.filename);
    }
}

/**
 * Upload le template DOCX global
 * @param {FileList} files - Fichier DOCX
 */
export async function uploadT55DocxTemplate(files) {
    if (!files || files.length === 0) return;

    const file = files[0];
    if (!file.name.endsWith('.docx')) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier DOCX');
        return;
    }

    try {
        // Cr√©er un FormData pour envoyer le fichier au serveur
        const formData = new FormData();
        formData.append('template', file);

        console.log('[T55] Upload du template DOCX:', file.name);

        // Envoyer le fichier au serveur
        const response = await fetch('/api/t55/upload-template', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Erreur lors de l\'upload');
        }

        const result = await response.json();

        // Sauvegarder les infos du template (utiliser le nom de fichier serveur, pas le nom original)
        const templateData = {
            filename: result.filename, // Nom de fichier sur le serveur (avec timestamp)
            originalname: result.originalname, // Nom original pour affichage
            path: result.path,
            uploadDate: new Date().toISOString()
        };

        console.log('[T55] üíæ Sauvegarde des infos template sur le serveur:', templateData);
        const saveSuccess = await saveToStorage('t55DocxTemplate', templateData);

        if (saveSuccess) {
            console.log('[T55] ‚úÖ Template DOCX sauvegard√© sur le serveur avec succ√®s');
        } else {
            console.error('[T55] ‚ùå √âCHEC de la sauvegarde du template sur le serveur!');
        }

        // V√©rifier imm√©diatement que la sauvegarde a fonctionn√©
        const verification = await loadFromStorage('t55DocxTemplate');
        console.log('[T55] üîç V√©rification imm√©diate - Template recharg√©:', verification);

        // Mettre √† jour le statut (afficher le nom original, pas celui avec timestamp)
        const statusSpan = document.getElementById('t55DocxTemplateStatus');
        if (statusSpan) {
            statusSpan.innerHTML = `‚úÖ <strong style="color: #28a745;">${result.originalname}</strong> - ${(file.size / 1024).toFixed(1)} KB`;
        }

        alert(`‚úÖ Template DOCX "${result.originalname}" upload√© avec succ√®s !`);
        console.log('[T55] Template DOCX upload√©:', result.originalname, '‚Üí Serveur:', result.filename);
    } catch (error) {
        console.error('[T55] Erreur lors de l\'upload du template DOCX:', error);
        alert('‚ùå Erreur lors de l\'upload du template DOCX');
    }
}

/**
 * Charge le statut du template DOCX
 */
async function loadDocxTemplateStatus() {
    console.log('[T55] üì• Chargement du statut du template DOCX...');

    // Attendre que le DOM soit pr√™t ET que le socket soit connect√©
    let attempts = 0;
    const maxAttempts = 30; // Augment√© pour attendre la synchronisation
    const retryInterval = 300;

    const tryLoad = async () => {
        attempts++;
        const statusSpan = document.getElementById('t55DocxTemplateStatus');

        if (!statusSpan) {
            if (attempts < maxAttempts) {
                console.log(`[T55] ‚è≥ Attente du DOM (tentative ${attempts}/${maxAttempts})...`);
                setTimeout(tryLoad, retryInterval);
                return;
            } else {
                console.warn('[T55] ‚ö†Ô∏è √âl√©ment t55DocxTemplateStatus introuvable apr√®s', maxAttempts, 'tentatives');
                return;
            }
        }

        // V√©rifier si le socket est connect√© (pour s'assurer que la synchronisation peut fonctionner)
        const socket = window.socket || (window.io && window.io.socket);
        if (!socket || !socket.connected) {
            if (attempts < maxAttempts) {
                console.log(`[T55] ‚è≥ Attente de la connexion au serveur (tentative ${attempts}/${maxAttempts})...`);
                setTimeout(tryLoad, retryInterval);
                return;
            } else {
                console.warn('[T55] ‚ö†Ô∏è Socket non connect√© apr√®s', maxAttempts, 'tentatives');
                statusSpan.innerHTML = `<span style="color: #ff9800;">‚ö†Ô∏è Serveur non connect√©</span>`;
                return;
            }
        }

        // DOM pr√™t et socket connect√©, charger les donn√©es du serveur
        console.log('[T55] üîó Socket connect√©, chargement du template...');
        const template = await loadFromStorage('t55DocxTemplate');
        console.log('[T55] Template DOCX re√ßu du serveur:', template);

        if (template && template.filename) {
            // Afficher le nom original si disponible, sinon le nom de fichier serveur
            const displayName = template.originalname || template.filename;
            statusSpan.innerHTML = `‚úÖ <strong style="color: #28a745;">${displayName}</strong>`;
            console.log('[T55] ‚úÖ Template DOCX charg√© et affich√©:', displayName, '(Serveur:', template.filename, ')');
        } else {
            console.log('[T55] ‚ÑπÔ∏è Aucun template DOCX trouv√© sur le serveur');
            statusSpan.innerHTML = `<span style="color: #999;">Aucun template charg√©</span>`;
        }
    };

    tryLoad();
}

/**
 * Exporte le devis vers DOCX en utilisant le template
 */
export async function exportT55ToDOCX() {
    if (!currentEntrepreneur) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un entrepreneur');
        return;
    }

    try {
        // V√©rifier qu'un template est upload√©
        const template = await loadFromStorage('t55DocxTemplate');
        if (!template) {
            alert('‚ö†Ô∏è Veuillez d\'abord uploader un template DOCX');
            return;
        }

        console.log('[T55] D√©but de l\'export DOCX pour:', currentEntrepreneur);

        // R√©cup√©rer toutes les donn√©es du formulaire
        const entrepreneurData = t55Data.entrepreneurs[currentEntrepreneur];
        if (!entrepreneurData) {
            alert('‚ö†Ô∏è Aucune donn√©e pour cet entrepreneur');
            return;
        }

        // Pr√©parer les donn√©es pour le remplacement
        const templateData = {
            entrepreneur: currentEntrepreneur,
            ...entrepreneurData
        };

        console.log('[T55] üì¶ Template filename:', template.filename);
        console.log('[T55] üì¶ Donn√©es envoy√©es:', JSON.stringify(templateData, null, 2));

        // Envoyer au serveur pour g√©n√©rer le DOCX
        const response = await fetch('/api/t55/generate-docx', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                templateFilename: template.filename,
                data: templateData
            })
        });

        if (!response.ok) {
            const error = await response.json();
            console.error('[T55] ‚ùå Erreur serveur:', error);
            console.error('[T55] ‚ùå D√©tails:', error.details);
            console.error('[T55] ‚ùå Type:', error.type);
            throw new Error(error.error || 'Erreur lors de la g√©n√©ration du DOCX');
        }

        // R√©cup√©rer les informations du fichier g√©n√©r√©
        const result = await response.json();

        console.log('[T55] Export DOCX termin√© avec succ√®s:', result.fileName);

        // Proposer le t√©l√©chargement
        const telecharger = confirm(`‚úÖ Document g√©n√©r√© avec succ√®s!\n\nFichier: ${result.fileName}\n\nVoulez-vous t√©l√©charger le document maintenant?`);
        if (telecharger) {
            window.open(result.downloadUrl, '_blank');
        }

        // TODO: Ajouter √† un historique des devis g√©n√©r√©s (comme pour les avis syndicaux)
    } catch (error) {
        console.error('[T55] Erreur lors de l\'export DOCX:', error);
        alert('‚ùå Erreur lors de l\'export DOCX: ' + error.message);
    }
}

/**
 * Initialise la page T55 - charge toutes les donn√©es depuis le serveur
 */
async function initT55Page() {
    console.log('[T55] üîÑ Initialisation de la page T55...');

    // Charger toutes les donn√©es T55 depuis le serveur (entrepreneurs + formulaires)
    await loadT55Data();

    // Charger les statuts des templates (avec retry pour attendre le DOM)
    console.log('[T55] üìÑ Chargement des statuts des templates...');
    await loadPdfTemplateStatus();
    await loadDocxTemplateStatus();

    // Recharger le dernier entrepreneur s√©lectionn√© depuis le serveur
    const lastEntrepreneur = t55Data.currentEntrepreneur;
    if (lastEntrepreneur) {
        const select = document.getElementById('t55EntrepreneurSelect');
        if (select) {
            // V√©rifier que l'entrepreneur existe toujours dans la liste
            const option = Array.from(select.options).find(opt => opt.value === lastEntrepreneur);
            if (option) {
                select.value = lastEntrepreneur;
                console.log('[T55] üë§ Rechargement de l\'entrepreneur depuis le serveur:', lastEntrepreneur);
                // Charger ses donn√©es
                await loadT55EntrepreneurData();
            } else {
                console.log('[T55] ‚ö†Ô∏è L\'entrepreneur sauvegard√© n\'existe plus:', lastEntrepreneur);
                t55Data.currentEntrepreneur = '';
                await saveToStorage('t55Data', t55Data);
            }
        }
    }

    console.log('[T55] ‚úÖ Page T55 initialis√©e avec toutes les donn√©es');
}

// Exposer une fonction pour le rechargement de la page T55
// Cette fonction est appel√©e par le page-loader quand la page devient visible
if (typeof window !== 'undefined') {
    // Variable pour √©viter les initialisations multiples simultan√©es
    let isInitializing = false;
    let lastInitTime = 0;

    // Fonction d'initialisation avec throttle
    async function safeInitT55Page() {
        const now = Date.now();
        // √âviter les initialisations trop rapproch√©es (moins de 500ms)
        if (isInitializing || (now - lastInitTime) < 500) {
            console.log('[T55] ‚è≠Ô∏è Initialisation d√©j√† en cours ou trop r√©cente, skip');
            return;
        }

        isInitializing = true;
        lastInitTime = now;
        try {
            await initT55Page();
        } finally {
            isInitializing = false;
        }
    }

    // Exposer la fonction globalement pour que le page-loader puisse l'appeler
    window.reloadT55Page = async () => {
        console.log('[T55] üîÑ Rechargement forc√© depuis page-loader');
        await safeInitT55Page();
    };

    console.log('[T55] ‚úÖ Module T55 charg√© - reloadT55Page expos√©e globalement');
}

// Exposer les fonctions globalement
if (typeof window !== 'undefined') {
    window.syncT55Entrepreneurs = syncT55Entrepreneurs;
    window.loadT55EntrepreneurData = loadT55EntrepreneurData;
    window.saveT55Data = saveT55Data;
    window.addT55DessinRow = addT55DessinRow;
    window.deleteT55DessinRow = deleteT55DessinRow;
    window.addT55ConvertisseurRow = addT55ConvertisseurRow;
    window.deleteT55ConvertisseurRow = deleteT55ConvertisseurRow;
    window.addT55CouleeContinueRow = addT55CouleeContinueRow;
    window.deleteT55CouleeContinueRow = deleteT55CouleeContinueRow;
    window.addT55HistoriqueRow = addT55HistoriqueRow;
    window.deleteT55HistoriqueRow = deleteT55HistoriqueRow;
    window.exportT55ToPDF = exportT55ToPDF;
    window.uploadT55PdfTemplate = uploadT55PdfTemplate;
    window.exportT55ToDOCX = exportT55ToDOCX;
    window.uploadT55DocxTemplate = uploadT55DocxTemplate;
}

console.log('[T55] Module charg√©');
